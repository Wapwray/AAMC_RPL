<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RPL Admin</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        --bg: #f4f6f9;
        --card: #ffffff;
        --text: #0f172a;
        --muted: #64748b;
        --border: #e2e8f0;
        --primary: #0b6ea9;
        --primary-dark: #095c8b;
      }
      * { box-sizing: border-box; }
      body { margin: 0; background: var(--bg); color: var(--text); }
      .page { padding: 24px; }
      .shell { max-width: 1100px; margin: 0 auto; display: grid; gap: 18px; }
      .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 18px; box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08); }
      h1, h2 { margin: 0 0 10px; }
      .muted { color: var(--muted); font-size: 13px; }
      .grid { display: grid; gap: 16px; }
      .twoCol { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
      textarea { width: 100%; min-height: 240px; border: 1px solid var(--border); border-radius: 10px; padding: 12px; font: inherit; background: #ffffff; }
      button { appearance: none; border: none; border-radius: 999px; padding: 10px 16px; font-size: 14px; font-weight: 600; background: var(--primary); color: #ffffff; cursor: pointer; transition: background 0.2s ease; }
      button.secondary { background: #ffffff; color: var(--primary); border: 1px solid #c7d9e8; }
      button:hover:not(:disabled) { background: var(--primary-dark); }
      button.secondary:hover:not(:disabled) { background: #eef6ff; }
      .actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
      .tagRow { display: flex; gap: 8px; flex-wrap: wrap; }
      .tag { font-size: 12px; padding: 4px 10px; border-radius: 999px; background: #eef6ff; border: 1px solid #c7d9e8; color: #0b6ea9; }
      .historyList { list-style: none; padding: 0; margin: 0; display: grid; gap: 8px; }
      .historyItem { display: flex; justify-content: space-between; gap: 10px; align-items: center; border: 1px solid var(--border); border-radius: 10px; padding: 10px; background: #ffffff; }
      .historyItem small { color: var(--muted); }
      .status { font-size: 13px; color: var(--muted); }
      .notice { font-size: 12px; color: var(--muted); }
      .sectionTitle { display: flex; justify-content: space-between; align-items: baseline; gap: 8px; }
      .divider { height: 1px; background: var(--border); margin: 8px 0 16px; }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="shell">
        <div class="card">
          <h1>RPL Admin</h1>
          <div class="muted">Edit the AI prompt templates used by the quiz. Templates are loaded from prompts.json at runtime.</div>
          <div class="divider"></div>
          <div class="twoCol">
            <div>
              <h2>Where fields are used</h2>
              <div class="muted">Field usage in prompts and system payloads:</div>
              <ul>
                <li><strong>FullName</strong> — Prompt templates, transcript header, webhook payloads.</li>
                <li><strong>GivenName</strong> — Prompt templates, webhook payloads.</li>
                <li><strong>ContactID</strong> — Prompt templates, transcript header, webhook payloads.</li>
              </ul>
              <div class="notice">Note: Updating prompts here affects prompts.json content that must be deployed for the quiz to use new versions.</div>
              <div class="actions" style="margin-top:12px;">
                <button id="downloadBtn" class="secondary">Download prompts.json</button>
                <button id="resetBtn" class="secondary">Reset to file</button>
              </div>
              <div class="status" id="adminStatus" style="margin-top:10px;">Ready.</div>
            </div>
            <div>
              <h2>Tokens</h2>
              <div class="muted">Use these tokens in templates:</div>
              <div class="tagRow" id="tokenList"></div>
            </div>
          </div>
        </div>

        <div class="card grid">
          <div class="sectionTitle">
            <h2>Assessment Prompt</h2>
            <span class="muted">File key: assessmentPrompt</span>
          </div>
          <textarea id="assessmentPrompt"></textarea>
          <div class="actions">
            <button id="saveAssessment">Save version</button>
            <button id="restoreAssessment" class="secondary">Restore selected</button>
          </div>
          <ul class="historyList" id="assessmentHistory"></ul>
        </div>

        <div class="card grid">
          <div class="sectionTitle">
            <h2>Final Review Prompt</h2>
            <span class="muted">File key: finalReviewPrompt</span>
          </div>
          <textarea id="finalPrompt"></textarea>
          <div class="actions">
            <button id="saveFinal">Save version</button>
            <button id="restoreFinal" class="secondary">Restore selected</button>
          </div>
          <ul class="historyList" id="finalHistory"></ul>
        </div>
      </div>
    </div>

    <script>
      const PROMPTS_URL = "/prompts.json";
      const TOKENS = [
        "{{FullName}}",
        "{{GivenName}}",
        "{{ContactID}}",
        "{{Industry}}",
        "{{JobTitle}}",
        "{{QuestionText}}",
        "{{Objective}}",
        "{{Answers}}",
        "{{ReviewText}}"
      ];

      const assessmentEl = document.getElementById("assessmentPrompt");
      const finalEl = document.getElementById("finalPrompt");
      const assessmentHistoryEl = document.getElementById("assessmentHistory");
      const finalHistoryEl = document.getElementById("finalHistory");
      const statusEl = document.getElementById("adminStatus");
      const tokenListEl = document.getElementById("tokenList");
      const downloadBtn = document.getElementById("downloadBtn");
      const resetBtn = document.getElementById("resetBtn");

      const setStatus = (message) => {
        if (statusEl) statusEl.textContent = message;
      };

      const loadPromptsFile = async () => {
        const response = await fetch(PROMPTS_URL, { cache: "no-store" });
        if (!response.ok) throw new Error(`Failed to load prompts.json (${response.status})`);
        return response.json();
      };

      const getHistoryKey = (name) => `rplPromptHistory:${name}`;

      const loadHistory = (name) => {
        try {
          const raw = localStorage.getItem(getHistoryKey(name));
          return raw ? JSON.parse(raw) : [];
        } catch {
          return [];
        }
      };

      const saveHistory = (name, history) => {
        localStorage.setItem(getHistoryKey(name), JSON.stringify(history.slice(0, 20)));
      };

      const renderHistory = (listEl, history, selectedIdRef) => {
        listEl.textContent = "";
        history.forEach((entry) => {
          const item = document.createElement("li");
          item.className = "historyItem";
          const left = document.createElement("div");
          left.innerHTML = `<div><strong>${entry.label}</strong></div><small>${new Date(entry.timestamp).toLocaleString()}</small>`;
          const right = document.createElement("div");
          const selectBtn = document.createElement("button");
          selectBtn.textContent = entry.id === selectedIdRef.value ? "Selected" : "Select";
          selectBtn.className = "secondary";
          selectBtn.addEventListener("click", () => {
            selectedIdRef.value = entry.id;
            renderHistory(listEl, history, selectedIdRef);
          });
          right.appendChild(selectBtn);
          item.appendChild(left);
          item.appendChild(right);
          listEl.appendChild(item);
        });
      };

      const selectedAssessment = { value: null };
      const selectedFinal = { value: null };

      const saveVersion = (name, content) => {
        const history = loadHistory(name);
        const entry = {
          id: crypto.randomUUID(),
          label: `Version ${history.length + 1}`,
          timestamp: Date.now(),
          content
        };
        history.unshift(entry);
        saveHistory(name, history);
        return history;
      };

      const restoreVersion = (name, selectedId) => {
        const history = loadHistory(name);
        return history.find((entry) => entry.id === selectedId) || null;
      };

      const downloadPrompts = async () => {
        const data = {
          assessmentPrompt: assessmentEl.value,
          finalReviewPrompt: finalEl.value
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "prompts.json";
        a.click();
        URL.revokeObjectURL(url);
      };

      TOKENS.forEach((token) => {
        const tag = document.createElement("span");
        tag.className = "tag";
        tag.textContent = token;
        tokenListEl.appendChild(tag);
      });

      document.getElementById("saveAssessment").addEventListener("click", () => {
        const history = saveVersion("assessment", assessmentEl.value);
        selectedAssessment.value = history[0]?.id || null;
        renderHistory(assessmentHistoryEl, history, selectedAssessment);
        setStatus("Assessment prompt version saved.");
      });

      document.getElementById("restoreAssessment").addEventListener("click", () => {
        const entry = restoreVersion("assessment", selectedAssessment.value);
        if (!entry) {
          setStatus("Select a version to restore.");
          return;
        }
        assessmentEl.value = entry.content;
        setStatus("Assessment prompt restored.");
      });

      document.getElementById("saveFinal").addEventListener("click", () => {
        const history = saveVersion("final", finalEl.value);
        selectedFinal.value = history[0]?.id || null;
        renderHistory(finalHistoryEl, history, selectedFinal);
        setStatus("Final review prompt version saved.");
      });

      document.getElementById("restoreFinal").addEventListener("click", () => {
        const entry = restoreVersion("final", selectedFinal.value);
        if (!entry) {
          setStatus("Select a version to restore.");
          return;
        }
        finalEl.value = entry.content;
        setStatus("Final review prompt restored.");
      });

      downloadBtn.addEventListener("click", downloadPrompts);

      resetBtn.addEventListener("click", async () => {
        try {
          const prompts = await loadPromptsFile();
          assessmentEl.value = prompts.assessmentPrompt || "";
          finalEl.value = prompts.finalReviewPrompt || "";
          setStatus("Prompts reset to file version.");
        } catch (err) {
          setStatus(err?.message || "Unable to reset prompts.");
        }
      });

      (async () => {
        try {
          const prompts = await loadPromptsFile();
          assessmentEl.value = prompts.assessmentPrompt || "";
          finalEl.value = prompts.finalReviewPrompt || "";

          const assessmentHistory = loadHistory("assessment");
          const finalHistory = loadHistory("final");
          selectedAssessment.value = assessmentHistory[0]?.id || null;
          selectedFinal.value = finalHistory[0]?.id || null;
          renderHistory(assessmentHistoryEl, assessmentHistory, selectedAssessment);
          renderHistory(finalHistoryEl, finalHistory, selectedFinal);
          setStatus("Prompts loaded.");
        } catch (err) {
          setStatus(err?.message || "Unable to load prompts.");
        }
      })();
    </script>
  </body>
</html>
